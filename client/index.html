<!doctype html>
<html>
  <head>
    <title>Real Time Polling App using Socket.io</title>
  </head>
  <body>
    <!-- Import dependencies -->
    <!-- https://cdnjs.com/libraries/socket.io -->
    <!-- https://cdnjs.com/libraries/Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>

    <!-- The title -->
    <h1 style="text-align: center">
      What is your restaurant choice for Friday March 29, 2024?
    </h1>

    <!-- The canvas -->
    <canvas id="voteChart" style="height: 50vh; width: 100vw"></canvas>

    <!-- Initialize the buttons, what they will look like on page-->
    <button onclick="vote(0)">Tap House</button>
    <button onclick="vote(1)">Barrel House</button>
    <button onclick="vote(2)">Red Cow</button>
    <button onclick="vote(3)">Tavern On France</button>

    <script>
      // Initialize the canvas
      const ctx = document.getElementById("voteChart").getContext("2d");

      // Initialize the chart
      const chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Candidates"],
        },
        options: {},
      });

      // Connect to the server - (const port) line 6 in server.js needs to match here to talk to each other
      const socket = io("localhost:3301");

      // On new vote update the chart
      socket.on("update", (candidates) => {
        // Convert the candidates object into an array
        candidates = Object.entries(candidates);

        // For each candidate
        for (const [key, candidate] of candidates) {
          //update the vote if the candidate already exists if not create a new candidate and then update the vote
          if (
            typeof chart.data.datasets[key] == "undefined" &&
            chart.data.datasets.length < candidates.length
          ) {
            chart.data.datasets.push({
              backgroundColor: candidate.color,
              borderColor: candidate.color,
              data: [candidate.votes],
              label: candidate.label,
            });
          } else if (typeof chart.data.datasets[key] != "undefined") {
            chart.data.datasets[key].data = [candidate.votes];
          }
        }
          // Update the chart
          chart.update();
      });

      // Make a new vote (remember this could be manipulated - by
      // inspect, console, vote(1) and change poll results via loop or interval
      function vote(index) {
        socket.emit("vote", index);
      }

    </script>
  </body>
</html>
